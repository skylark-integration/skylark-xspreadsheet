/**
 * skylark-xspreadsheet - A version of xspreadsheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./element","./suggest","./datepicker","../config"],function(t,e,s,i){"use strict";function l(){const{inputText:t}=this;if(!/^\s*$/.test(t)){const{textlineEl:e,textEl:s,areaOffset:i}=this,l=t.split("\n"),n=Math.max(...l.map(t=>t.length)),h=e.offset().width/t.length,a=(n+1)*h+5,o=this.viewFn().width-i.left-h;let c=l.length;if(a>i.width){let t=a;a>o&&(t=o,c+=parseInt(a/o,10),c+=a%o>0?1:0),s.css("width",`${t}px`)}(c*=this.rowHeight)>i.height&&s.css("height",`${c}px`)}}function n(t){const{keyCode:e,altKey:s}=t;13!==e&&9!==e&&t.stopPropagation(),13===e&&s&&(function({target:t},e){const{value:s,selectionEnd:i}=t,n=`${s.slice(0,i)}${e}${s.slice(i)}`;t.value=n,t.setSelectionRange(i+1,i+1),this.inputText=n,this.textlineEl.html(n),l.call(this)}.call(this,t,"\n"),t.stopPropagation()),13!==e||s||t.preventDefault()}function h(t,e){const{textEl:s,textlineEl:i}=this;s.el.blur(),s.val(t),i.html(t),function(t){const{el:e}=this.textEl;setTimeout(()=>{e.focus(),e.setSelectionRange(t,t)},0)}.call(this,e)}return class{constructor(a,o,c){this.viewFn=o,this.rowHeight=c,this.formulas=a,this.suggest=new e(a,t=>{(function(t){const{inputText:e,validator:s}=this;let i=0;if(s&&"list"===s.type)this.inputText=t,i=this.inputText.length;else{const s=e.lastIndexOf("="),l=e.substring(0,s+1);let n=e.substring(s+1);n=-1!==n.indexOf(")")?n.substring(n.indexOf(")")):"",this.inputText=`${l+t.key}(`,i=this.inputText.length,this.inputText+=`)${n}`}h.call(this,this.inputText,i)}).call(this,t)}),this.datepicker=new s,this.datepicker.change(t=>{this.setText(function(t){let e=t.getMonth()+1,s=t.getDate();return e<10&&(e=`0${e}`),s<10&&(s=`0${s}`),`${t.getFullYear()}-${e}-${s}`}(t)),this.clear()}),this.areaEl=t.h("div",`${i.cssPrefix}-editor-area`).children(this.textEl=t.h("textarea","").on("input",t=>(function(t){const e=t.target.value,{suggest:s,textlineEl:i,validator:n}=this,{cell:h}=this;if(null!==h)if("editable"in h&&!0===h.editable||void 0===h.editable){if(this.inputText=e,n)"list"===n.type?s.search(e):s.hide();else{const t=e.lastIndexOf("=");-1!==t?s.search(e.substring(t+1)):s.hide()}i.html(e),l.call(this),this.change("input",e)}else t.target.value="";else{if(this.inputText=e,n)"list"===n.type?s.search(e):s.hide();else{const t=e.lastIndexOf("=");-1!==t?s.search(e.substring(t+1)):s.hide()}i.html(e),l.call(this),this.change("input",e)}}).call(this,t)).on("paste.stop",()=>{}).on("keydown",t=>n.call(this,t)),this.textlineEl=t.h("div","textline"),this.suggest.el,this.datepicker.el).on("mousemove.stop",()=>{}).on("mousedown.stop",()=>{}),this.el=t.h("div",`${i.cssPrefix}-editor`).child(this.areaEl).hide(),this.suggest.bindInputEvents(this.textEl),this.areaOffset=null,this.freeze={w:0,h:0},this.cell=null,this.inputText="",this.change=(()=>{})}setFreezeLengths(t,e){this.freeze.w=t,this.freeze.undefined=e}clear(){""!==this.inputText&&this.change("finished",this.inputText),this.cell=null,this.areaOffset=null,this.inputText="",this.el.hide(),this.textEl.val(""),this.textlineEl.html(""),function(){this.suggest.setItems(this.formulas)}.call(this),this.datepicker.hide()}setOffset(t,e="top"){const{textEl:s,areaEl:i,suggest:l,freeze:n,el:h}=this;if(t){this.areaOffset=t;const{left:a,top:o,width:c,height:u,l:f,t:r}=t,d={left:0,top:0};n.w>f&&n.undefined>r||(n.w<f&&n.undefined<r?(d.left=n.w,d.top=n.undefined):n.w>f?d.top=n.undefined:n.undefined>r&&(d.left=n.w)),h.offset(d),i.offset({left:a-d.left-.8,top:o-d.top-.8}),s.offset({width:c-9+.8,height:u-3+.8});const p={left:0};p[e]=u,l.setOffset(p),l.hide()}}setCell(t,e){const{el:s,datepicker:i,suggest:l}=this;s.show(),this.cell=t;const n=t&&t.text||"";if(this.setText(n),this.validator=e,e){const{type:t}=e;"date"===t&&(i.show(),/^\s*$/.test(n)||i.setValue(n)),"list"===t&&(l.setItems(e.values()),l.search(""))}}setText(t){this.inputText=t,h.call(this,t,t.length),l.call(this)}}});
//# sourceMappingURL=../sourcemaps/component/editor.js.map
