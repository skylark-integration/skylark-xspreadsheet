{"version":3,"sources":["component/print.js"],"names":["define","m_element","m_config","Button","m_draw","m_table","m_locale","PAGER_SIZES","PAGER_ORIENTATIONS","inches2px","inc","parseInt","btnClick","type","this","el","hide","toPrint","[object Object]","data","paper","w","h","padding","orientation","width","undefined","height","cssPrefix","children","child","on","bind","contentEl","t","map","it","index","attr","evt","value","target","ps","preview","v","iwidth","iheight","cr","contentRange","pages","scale","left","top","ri","yoffset","html","canvases","mViewRange","sri","sci","eri","eci","i","th","yo","wrap","canvas","push","draw","Draw","save","translate","rh","rows","getHeight","ci","renderCell","restore","yof","eachMergesInView","show","iframe","window","document","body","appendChild","contentWindow","idoc","style","createElement","innerHTML","head","forEach","cn","cloneNode","getContext","drawImage","print"],"mappings":"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","file":"../../component/print.js","sourcesContent":["define([\n    './element',\n    '../config',\n    './button',\n    '../canvas/draw',\n    './table',\n    '../locale/locale'\n], function (m_element, m_config, Button, m_draw, m_table, m_locale) {\n    'use strict';\n    const PAGER_SIZES = [\n        [\n            'A3',\n            11.69,\n            16.54\n        ],\n        [\n            'A4',\n            8.27,\n            11.69\n        ],\n        [\n            'A5',\n            5.83,\n            8.27\n        ],\n        [\n            'B4',\n            9.84,\n            13.9\n        ],\n        [\n            'B5',\n            6.93,\n            9.84\n        ]\n    ];\n    const PAGER_ORIENTATIONS = [\n        'landscape',\n        'portrait'\n    ];\n    function inches2px(inc) {\n        return parseInt(96 * inc, 10);\n    }\n    function btnClick(type) {\n        if (type === 'cancel') {\n            this.el.hide();\n        } else {\n            this.toPrint();\n        }\n    }\n    function pagerSizeChange(evt) {\n        const {paper} = this;\n        const {value} = evt.target;\n        const ps = PAGER_SIZES[value];\n        paper.w = inches2px(ps[1]);\n        paper.undefined = inches2px(ps[2]);\n        this.preview();\n    }\n    function pagerOrientationChange(evt) {\n        const {paper} = this;\n        const {value} = evt.target;\n        const v = PAGER_ORIENTATIONS[value];\n        paper.orientation = v;\n        this.preview();\n    }\n    return class Print {\n        constructor(data) {\n            this.paper = {\n                w: inches2px(PAGER_SIZES[0][1]),\n                h: inches2px(PAGER_SIZES[0][2]),\n                padding: 50,\n                orientation: PAGER_ORIENTATIONS[0],\n                get width() {\n                    return this.orientation === 'landscape' ? this.undefined : this.w;\n                },\n                get height() {\n                    return this.orientation === 'landscape' ? this.w : this.undefined;\n                }\n            };\n            this.data = data;\n            this.el = m_element.h('div', `${ m_config.cssPrefix }-print`).children(m_element.h('div', `${ m_config.cssPrefix }-print-bar`).children(m_element.h('div', '-title').child('Print settings'), m_element.h('div', '-right').children(m_element.h('div', `${ m_config.cssPrefix }-buttons`).children(new Button('cancel').on('click', btnClick.bind(this, 'cancel')), new Button('next', 'primary').on('click', btnClick.bind(this, 'next'))))), m_element.h('div', `${ m_config.cssPrefix }-print-content`).children(this.contentEl = m_element.h('div', '-content'), m_element.h('div', '-sider').child(m_element.h('form', '').children(m_element.h('fieldset', '').children(m_element.h('label', '').child(`${ m_locale.t('print.size') }`), m_element.h('select', '').children(...PAGER_SIZES.map((it, index) => m_element.h('option', '').attr('value', index).child(`${ it[0] } ( ${ it[1] }''x${ it[2] }'' )`))).on('change', pagerSizeChange.bind(this))), m_element.h('fieldset', '').children(m_element.h('label', '').child(`${ m_locale.t('print.orientation') }`), m_element.h('select', '').children(...PAGER_ORIENTATIONS.map((it, index) => m_element.h('option', '').attr('value', index).child(`${ m_locale.t('print.orientations')[index] }`))).on('change', pagerOrientationChange.bind(this))))))).hide();\n        }\n        resetData(data) {\n            this.data = data;\n        }\n        preview() {\n            const {data, paper} = this;\n            const {width, height, padding} = paper;\n            const iwidth = width - padding * 2;\n            const iheight = height - padding * 2;\n            const cr = data.contentRange();\n            const pages = parseInt(cr.undefined / iheight, 10) + 1;\n            const scale = iwidth / cr.w;\n            let left = padding;\n            const top = padding;\n            if (scale > 1) {\n                left += (iwidth - cr.w) / 2;\n            }\n            let ri = 0;\n            let yoffset = 0;\n            this.contentEl.html('');\n            this.canvases = [];\n            const mViewRange = {\n                sri: 0,\n                sci: 0,\n                eri: 0,\n                eci: 0\n            };\n            for (let i = 0; i < pages; i += 1) {\n                let th = 0;\n                let yo = 0;\n                const wrap = m_element.h('div', `${ m_config.cssPrefix }-canvas-card`);\n                const canvas = m_element.h('canvas', `${ m_config.cssPrefix }-canvas`);\n                this.canvases.push(canvas.el);\n                const draw = new m_draw.Draw(canvas.el, width, height);\n                draw.save();\n                draw.translate(left, top);\n                if (scale < 1)\n                    draw.scale(scale, scale);\n                for (; ri <= cr.eri; ri += 1) {\n                    const rh = data.rows.getHeight(ri);\n                    th += rh;\n                    if (th < iheight) {\n                        for (let ci = 0; ci <= cr.eci; ci += 1) {\n                            m_table.renderCell(draw, data, ri, ci, yoffset);\n                            mViewRange.eci = ci;\n                        }\n                    } else {\n                        yo = -(th - rh);\n                        break;\n                    }\n                }\n                mViewRange.eri = ri;\n                draw.restore();\n                draw.save();\n                draw.translate(left, top);\n                if (scale < 1)\n                    draw.scale(scale, scale);\n                const yof = yoffset;\n                data.eachMergesInView(mViewRange, ({sri, sci}) => {\n                    m_table.renderCell(draw, data, sri, sci, yof);\n                });\n                draw.restore();\n                mViewRange.sri = mViewRange.eri;\n                mViewRange.sci = mViewRange.eci;\n                yoffset += yo;\n                this.contentEl.child(m_element.h('div', `${ m_config.cssPrefix }-canvas-card-wraper`).child(wrap.child(canvas)));\n            }\n            this.el.show();\n        }\n        toPrint() {\n            this.el.hide();\n            const {paper} = this;\n            const iframe = m_element.h('iframe', '').hide();\n            const {el} = iframe;\n            window.document.body.appendChild(el);\n            const {contentWindow} = el;\n            const idoc = contentWindow.document;\n            const style = document.createElement('style');\n            style.innerHTML = `\n      @page { size: ${ paper.width }px ${ paper.height }px; };\n      canvas {\n        page-break-before: auto;        \n        page-break-after: always;\n        image-rendering: pixelated;\n      };\n    `;\n            idoc.head.appendChild(style);\n            this.canvases.forEach(it => {\n                const cn = it.cloneNode(false);\n                const ctx = cn.getContext('2d');\n                ctx.drawImage(it, 0, 0);\n                idoc.body.appendChild(cn);\n            });\n            contentWindow.print();\n        }\n    };\n});"]}